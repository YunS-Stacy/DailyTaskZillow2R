{
    "collab_server" : "",
    "contents" : "library('bigrquery')\nlibrary('rvest')\nlibrary('stringr')\nlibrary('shinyFiles')\nlibrary('xml2')\n\nhtml_1 <- read_html(\"https://www.zillow.com/homes/recently_sold/Philadelphia-PA/apartment_duplex_type/days_sort/\")\n\n#Get Prices\nprice_1 <- html_nodes(html_1, css='.zsg-photo-card-status') %>% \n  html_text() %>% str_replace(\"SOLD: \", \"\")\n#Get Housing Info\ninfos_1 <- html_nodes(html_1, css='.zsg-photo-card-info') %>% \n  html_text()\n##price per sqft\nunitprice_1 <- infos_1 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][1] %>%\n      str_replace(fixed(\"Price/sqft: \"), \"\")})\n##beds\nbeds_1 <- infos_1 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][2] %>%\n      str_replace(fixed(\" bds\"), \"\") %>%\n      str_replace(fixed(\" bd\"), \"\")\n  })\n\n##baths\nbaths_1 <- infos_1 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][3] %>%\n      str_replace(fixed(\" ba\"), \"\")\n  })\n#area\narea_1 <- infos_1 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][4] %>%\n      str_replace(fixed(\" sqft\"), \"\")\n  })\n\n#Get sold date\nsolddate_1 <- html_nodes(html_1, css='.zsg-photo-card-notification') %>% \n  html_text() %>%\n  str_replace(\"Sold \",'') %>%\n  as.Date(format = '%m/%d/%Y')\n\n#Get address\naddress_1 <- html_nodes(html_1, css='.zsg-photo-card-address') %>% \n  html_text() %>%\n  str_replace(\", Philadelphia, PA\",'')\n\nlatest_1 <- data.frame(address_1, solddate_1, price_1, unitprice_1, beds_1, baths_1, area_1, row.names = NULL)\nnames(latest_1)  <- c('address', 'solddate', 'price', 'unitprice', 'beds', 'baths', 'area')\n\nhtml_2 <- read_html(\"https://www.zillow.com/homes/recently_sold/Philadelphia-PA/apartment_duplex_type/days_sort/2_p\")\n\n#Get Prices\nprice_2 <- html_nodes(html_2, css='.zsg-photo-card-status') %>% \n  html_text() %>% str_replace(\"SOLD: \", \"\")\n#Get Housing Info\ninfos_2 <- html_nodes(html_2, css='.zsg-photo-card-info') %>% \n  html_text()\n##price per sqft\nunitprice_2 <- infos_2 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][1] %>%\n      str_replace(fixed(\"Price/sqft: \"), \"\")})\n##beds\nbeds_2 <- infos_2 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][2] %>%\n      str_replace(fixed(\" bds\"), \"\") %>%\n      str_replace(fixed(\" bd\"), \"\")\n  })\n\n##baths\nbaths_2 <- infos_2 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][3] %>%\n      str_replace(fixed(\" ba\"), \"\")\n  })\n#area\narea_2 <- infos_2 %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][4] %>%\n      str_replace(fixed(\" sqft\"), \"\")\n  })\n\n#Get sold date\nsolddate_2 <- html_nodes(html_2, css='.zsg-photo-card-notification') %>% \n  html_text() %>%\n  str_replace(\"Sold \",'') %>%\n  as.Date(format = '%m/%d/%Y')\n\n#Get address\naddress_2 <- html_nodes(html_2, css='.zsg-photo-card-address') %>% \n  html_text() %>%\n  str_replace(\", Philadelphia, PA\",'')\nlatest_2 <- data.frame(address_2, solddate_2, price_2, unitprice_2, beds_2, baths_2, area_2, row.names = NULL)\nnames(latest_2)  <- c('address', 'solddate', 'price', 'unitprice', 'beds', 'baths', 'area')\n\ndatestart <- Sys.Date() - 30\n\nlatest <- cbind(rbind(latest_1,latest_2),datestart)\n\n# upload to google query\nproject <- \"smartselect-34c02\"\ndataset <- 'houseListing'\ntable <- 'zillow'\nget_dataset(project, dataset)\n\n#at first time, write_append to the last table\ninsert_upload_job(project, dataset, table, latest, billing = project, write_disposition = \"WRITE_APPEND\" )\n\n#query the latest 30 days\nsql <- 'SELECT address, solddate, price, unitprice, beds, baths, area, datestart FROM (\n          SELECT *, ROW_NUMBER() OVER (PARTITION BY address) row_number FROM houseListing.zillow)\n        WHERE row_number = 1 AND DATE(solddate) >= DATE(datestart)\n        ORDER BY solddate desc'\ntoday <- query_exec(sql, project, destination_table = NULL, default_dataset = dataset)\n\n#delete the last table and upload the new one\ndelete_table(project,dataset,table)\ninsert_upload_job(project, dataset, table, today, billing = project)\n",
    "created" : 1492717186324.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2418482324",
    "id" : "E808AD26",
    "lastKnownWriteTime" : 1492990942,
    "last_content_update" : 1492990942489,
    "path" : "~/Documents/myapp/scheduledR/taskZillow.R",
    "project_path" : "taskZillow.R",
    "properties" : {
        "docOutlineVisible" : "0",
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}