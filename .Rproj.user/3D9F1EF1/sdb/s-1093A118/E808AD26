{
    "collab_server" : "",
    "contents" : "library('bigrquery')\nlibrary('DBI')\nlibrary('RSelenium')\nlibrary('rvest')\nlibrary('stringr')\nlibrary('sqldf')\nlibrary('shinyFiles')\n#Open with chrome\nrD <- rsDriver(verbose = FALSE, port = 4446L)\nremDr <- remoteDriver( port = 4446L, browserName = 'chrome' )\nremDr <- rD$client\n\n#Launch the browser\nremDr$open()\n\n#Navigate to Zillow recent sold(Philly)\nremDr$navigate(\"https://www.zillow.com/homes/recently_sold/Philadelphia-PA/apartment_duplex_type/days_sort/\")\n\n#Get Prices\nprice <- remDr$findElements('css', '.zsg-photo-card-status') %>%\n           sapply(function(x){\n            x$getElementText() %>%\n            str_replace(\"SOLD: \", \"\")})\n#Get Housing Info\ninfos <- remDr$findElements('css', '.zsg-photo-card-info') %>%\n  sapply(function(x){\n    x$getElementText()\n    })\n##price per sqft\nunitprice <- infos %>% \n  sapply(function(x){\n      # unit price\n      strsplit(x,' · ')[[1]][1] %>%\n      str_replace(fixed(\"Price/sqft: \"), \"\")})\n##beds\nbeds <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][2] %>%\n      str_replace(fixed(\" bds\"), \"\") %>%\n      str_replace(fixed(\" bd\"), \"\")\n  })\n\n##baths\nbaths <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][3] %>%\n      str_replace(fixed(\" ba\"), \"\")\n  })\n#area\narea <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][4] %>%\n      str_replace(fixed(\" sqft\"), \"\")\n  })\n\n#Get sold date\nsolddate<- remDr$findElements('css', '.zsg-photo-card-notification') %>% \n  sapply(function(x){\n    x$getElementText() %>%\n             sapply(function(x){\n               str_replace(x, \"Sold \",'') %>%\n                 unlist()\n             })\n  }) %>%\n  as.Date(format = '%m/%d/%Y')\n\n#Get address\naddress <- remDr$findElements('css', '.zsg-photo-card-address') %>%\n  sapply(function(x){\n    unlist(x$getElementText() %>%\n             sapply(function(x){\n               str_replace(x, \", Philadelphia, PA\",'')\n             }))\n  })\n\nlatest_1 <- data.frame(address, solddate, price, unitprice, beds, baths, area)\n\nremDr$findElement('css', 'a.on')$clickElement()\n#Get Prices\nprice <- remDr$findElements('css', '.zsg-photo-card-status') %>%\n  sapply(function(x){\n    x$getElementText() %>%\n      str_replace(\"SOLD: \", \"\")})\n#Get Housing Info\ninfos <- remDr$findElements('css', '.zsg-photo-card-info') %>%\n  sapply(function(x){\n    x$getElementText()\n  })\n##price per sqft\nunitprice <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][1] %>%\n      str_replace(fixed(\"Price/sqft: \"), \"\")})\n##beds\nbeds <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][2] %>%\n      str_replace(fixed(\" bds\"), \"\") %>%\n      str_replace(fixed(\" bd\"), \"\")\n  })\n\n##baths\nbaths <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][3] %>%\n      str_replace(fixed(\" ba\"), \"\")\n  })\n#area\narea <- infos %>% \n  sapply(function(x){\n    # unit price\n    strsplit(x,' · ')[[1]][4] %>%\n      str_replace(fixed(\" sqft\"), \"\")\n  })\n\n#Get sold date\nsolddate<- remDr$findElements('css', '.zsg-photo-card-notification') %>% \n  sapply(function(x){\n    x$getElementText() %>%\n      sapply(function(x){\n        str_replace(x, \"Sold \",'') %>%\n          unlist()\n      })\n  }) %>%\n  as.Date(format = '%m/%d/%Y')\n\n#Get address\naddress <- remDr$findElements('css', '.zsg-photo-card-address') %>%\n  sapply(function(x){\n    unlist(x$getElementText() %>%\n             sapply(function(x){\n               str_replace(x, \", Philadelphia, PA\",'')\n             }))\n  })\n\n\nlatest_2 <- data.frame(address, solddate, price, unitprice, beds, baths, area)\ndatestart <- Sys.Date() - 30\n\nlatest <- cbind(rbind(latest_1,latest_2),datestart)\n\nremDr$close()\nrD$server$stop()\n\n# upload to google query\nproject <- \"smartselect-34c02\"\ndataset <- 'houseListing'\ntable <- 'zillow'\nget_dataset(project, dataset)\n\n#at first time, write_append to the last table\ninsert_upload_job(project, dataset, table, latest, billing = project, write_disposition = \"WRITE_APPEND\" )\n\n#query the latest 30 days\nsql <- 'SELECT address, solddate, price, unitprice, beds, baths, area, datestart FROM (\n          SELECT *, ROW_NUMBER() OVER (PARTITION BY address) row_number FROM houseListing.zillow)\n        WHERE row_number = 1 AND DATE(solddate) >= DATE(datestart)\n        ORDER BY solddate desc'\ntoday <- query_exec(sql, project, destination_table = NULL, default_dataset = dataset)\n\n#delete the last table and upload the new one\ndelete_table(project,dataset,table)\ninsert_upload_job(project, dataset, table, today, billing = project)\n\n",
    "created" : 1492717186324.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "853985082",
    "id" : "E808AD26",
    "lastKnownWriteTime" : 1492982019,
    "last_content_update" : 1492982019468,
    "path" : "~/Documents/myapp/scheduledR/taskZillow.R",
    "project_path" : "taskZillow.R",
    "properties" : {
        "docOutlineVisible" : "0",
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}